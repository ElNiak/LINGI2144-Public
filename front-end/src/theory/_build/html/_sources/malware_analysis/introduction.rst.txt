Malware Analysis
****************

Introduction
------------

What is a malware ?
~~~~~~~~~~~~~~~~~~~

Malware is a  **piece of code which changes the behavior** of either
the operating system kernel or some security sensitive
applications, **without a user consent** and in such a way that it
is then **impossible to detect those changes using a documented
features** of the operating system or the application (e.g.
API).  [1]_

Vector/Surface of attack
~~~~~~~~~~~~~~~~~~~~~~~~

#. **With consent**: for example, using teamviewer for technical
   support. In this case you gave your consent to someone to get full
   access to your computer. I let you enter, but does not mean you can
   install any type of code on my system ! (insiders). Another case is
   when you download your self a bad stuff.

#. **Without consent**: for example, again using teamviewer, an attacker
   could use it to maliciously take control of your computer. For
   example finding at vulnerability in protocol to do malicious things
   without the user "consent".

#. Here we have an example of **Potentially Unwanted Application
   (PUA)**. The more you let access to your computer the more you give
   your consent.

Malware classification (sample)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

**Malware classification** :math:`=` General traits of the malware, it
is useful to provide an overall description of malware’s behaviour and
to catch them with **honeypot**. It also help to characterize its
**signature** which is what identified the malware and hence is useful
to detect new one.

-  **Worm/Virus**: "a contagious piece of code that infects the other
   software on the host system and spreads itself once it is run. It is
   mostly known to spread when software is shared between computers.
   This acts more like a parasite”. A virus is a specific type of
   malware that spread and replicates. Malware are more general: "any
   expected/unwanted behavior". Most of Anti Viruses are anti malware.

-  **Spyware**: give information about what the victim is doing, collect
   information and send it, classical: keyloggers. (E.g keylogger)

-  **Bot(Net)**: can be use as computer power (E.g mirai botnet), same
   as backdoor, but all botnet infected with the same malware are
   controlled by a command and control server (C&C).

-  **Backdoor**: install itself onto a computer to allow the attacker
   access

-  **(Down)Loader**: load some file to prepare an attack, (E.g loading
   spyware)

-  **Ransomware**: encrypt data of the victim and promise decryption in
   exchange of ransom.

-  **Spam sending**: use the machine to send spam (that may contain
   infected behaviors)

-  **Scareware**: scare the user to make him/her buying something (e.g
   sexual scare)

-  **Rootkit**: code used to conceal existence of to her code

-  ...

| But there is no clear border, malware often belong to multiple
  categories. Example: a program that collect information and sends
  spam. It can be classified as keylogger if e.g. it collects
  information such as passwords and t can be classified as worm if it
  spreads within the spams it sends.

| We should not confused **classification of malware** (“this is a
  ransomware whose name is wannacry") and **family of malware** (“this
  is a rewriting of the code of wannacry"). Two malwares from the same
  family may have the same signature, *but this is rare*. Indeed: the
  objective of a family is to fool the detector with many variants.

Some famous malware
~~~~~~~~~~~~~~~~~~~

+-----------------------------------------------------------------------------------------+
|                                                                                         |
+==============+==========================================================================+
| Creeper      | -  1971, First networked virus.                                          |
|              |                                                                          |
|              | -  Infected several banks of mainframe computers through a proto         |
|              |    Internet, causing displays to flash an ominous “I’m the creeper,      |
|              |    catch me if you can.”                                                 |
|              |                                                                          |
|              | -  Result: programmers created the **first anti virus called Reaper**    |
+--------------+--------------------------------------------------------------------------+
| Michelangelo | -  1991, Famous for creating the first widespread malware panic          |
|              |                                                                          |
|              | -  Infects boot sectors                                                  |
|              |                                                                          |
|              | -  Viral infection of the news media “this virus would infect millions   |
|              |    of computers and shut down automation on March 6 (the real            |
|              |    Michelangelo’s birthday)”.                                            |
|              |                                                                          |
|              | -  Invisible until March 6, where it would essentially make all storage  |
|              |    irretrievable.                                                        |
+--------------+--------------------------------------------------------------------------+
| I Love You   | -  Released in 2000, when malware were a “myth”                          |
|              |                                                                          |
|              | -  **Spreads via emails, and via mIRC (love)**                           |
|              |                                                                          |
|              | -  Slowdown services, 5 billions dollars                                 |
|              |                                                                          |
|              | -  From Philipines , but no law against                                  |
+--------------+--------------------------------------------------------------------------+
| MyDoom.A     | -  Released in 2004, worm spread via emails or Kazaa                     |
|              |                                                                          |
|              | -  Open backdoors, tries to crash website via DDOS attacks               |
|              |                                                                          |
|              | -  In 2004, roughly somewhere between 16 25% of all emails had been      |
|              |    infected by MyDoom , cost 38 billions dollars.                        |
+--------------+--------------------------------------------------------------------------+
| StuxNet      | -  Spread by a USB thumb drive and targeted software controlling a       |
|              |    facility in Iran that held uranium.                                   |
|              |                                                                          |
|              | -  **Requires state power, first digital weapon**                        |
+--------------+--------------------------------------------------------------------------+
| CryptoLocker | -  Released in September 2013, spread through email attachments and      |
|              |    encrypted the user’s files so that they couldn’t access them.         |
|              |                                                                          |
|              | -  With 500,000 victims, CryptoLocker made upwards of 30 million dollars |
|              |    in 100 days [2]_                                                      |
+--------------+--------------------------------------------------------------------------+

:math:`\Rightarrow` **Situation** :math:`=`

-  More and more complex

-  With specific targets

-  With specific damages

-  Two examples: Wannacry and Mirai

-  ... Sadly, Coronavirus illustrates the problem

+--------------------------------------------------------------------------------+
|                                                                                |
+=============+==================================================================+
| WannaCry    | -  Self propagating ransomware                                   |
|             |                                                                  |
|             | -  Worm like behavior                                            |
|             |                                                                  |
|             | -  200K computers infects across 150 countries                   |
|             |                                                                  |
|             | -  SMBv1 vulnerability exploited by EternalBlue and DoublePulsar |
+-------------+------------------------------------------------------------------+
| Coronavirus | -  Lots of hackers have exploited the situation                  |
|             |                                                                  |
|             | -  To attack hospital (ransomware, keylogger, …)                 |
|             |                                                                  |
|             | -  Difference between white hats and black hats                  |
+-------------+------------------------------------------------------------------+

Malware analysis: Steps
~~~~~~~~~~~~~~~~~~~~~~~

#. Malware is noticed by someone/ something

#. Analyst examines sample and confirms it’s malware

#. Analyst write a signatur e for the malware

#. Anti malware engines receive the rule and update themselves

#. Malware now detected and stopped

.. [1]
   https://blog.invisiblethings.org/papers/2006/rutkowska_malware_taxonomy.pdf

.. [2]
   https://www.pcworld.com/article/2082204/crime-pays-very-well-cryptolocker-grosses-up-to-30-million-in-ransom.html

.. include:: mirai.rst
.. include:: malware_sample.rst
.. include:: analysis.rst
.. include:: static_analysis.rst
.. include:: dynamic_analysis.rst
.. include:: packing.rst