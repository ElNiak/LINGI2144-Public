
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>More on packing &#8212; Theory 2020 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/my-style.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2020',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Malware Analysis II" href="../malware_analysisII/static_analysis.html" />

<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/script.js"></script>





  </head>
  <body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/UCLouvain_Logo+moodle.png"></span>
          LINGI2144</a>
        <span class="navbar-text navbar-version pull-left"><b>2020</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="/LINGI2144-Secured-System-Engineering-Syllabus/_build/html/index.html">Main</a></li>
                <li><a href="https://github.com/ElNiak/LINGI2144-Secured-System-Engineering-Syllabus.git">GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Section <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/introduction.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/introduction.html#objectives">Objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/introduction.html#security-a-definition">Security: A definition ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/introduction.html#attackers-motivations">Attacker’s motivations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/introduction.html#risk-analysis">Risk analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/introduction.html#attacks-classification">Attacks classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/introduction.html#from-vulnerabilities-to-exploit">From vulnerabilities to exploit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/introduction.html#some-counter-measures">Some counter measures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/introduction.html#hardware-hack">Hardware Hack</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/introduction.html#additional-content">Additional content</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../basis/privilege.html">Basic attacks/defences</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../basis/privilege.html#privileges-escalation">Privileges escalation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basis/privilege.html#integer-overflow">Integer Overflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basis/privilege.html#exploit-concurrency">Exploit Concurrency</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../memory_safety/corruption.html">Memory Safety</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../memory_safety/corruption.html#memory-handling-and-impact-of-memory-corruption">Memory handling and impact of memory corruption</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory_safety/corruption.html#vulnerabilities-stack-and-heap">Vulnerabilities stack and heap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory_safety/corruption.html#id13">Memory Safety</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory_safety/corruption.html#prevention-detection">Prevention/detection</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../assembly/assembly.html">Assembly/Debugger</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../assembly/assembly.html#assembly">Assembly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assembly/assembly.html#debugger-disassembler-decompiler">Debugger - disassembler - decompiler</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../buffer_overflow/exploit1.html">Buffer Overflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../buffer_overflow/exploit1.html#exploit-erase-value-of-other-local-variables">Exploit: Erase value of other local variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../buffer_overflow/exploit1.html#exploit-dos">Exploit: DoS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../buffer_overflow/exploit1.html#exploit-shellcode">Exploit: Shellcode</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../complement_on_buffer/complement.html">Complement on BO</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../complement_on_buffer/complement.html#situation-a-function-foo-that-call-function-bar">Situation: a function FOO that call function BAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../complement_on_buffer/complement.html#the-off-by-one-vulnerability">The “off by one vulnerability”</a></li>
<li class="toctree-l2"><a class="reference internal" href="../complement_on_buffer/complement.html#a-note-on-architecture">A note on architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../complement_on_buffer/complement.html#common-student-questions">Common student questions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../shellcode/handmake.html">Shellcode</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../shellcode/handmake.html#hand-made-shellcode">Hand made shellcode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shellcode/handmake.html#dedicated-tools">Dedicated tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../stack_protection/nonexec.html">Stack Protection</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../stack_protection/nonexec.html#non-executable-stack">Non Executable Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stack_protection/nonexec.html#stackshield">StackShield</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stack_protection/nonexec.html#stackguard">StackGuard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../stack_protection/nonexec.html#address-space-layout-randomization-aslr">Address Space Layout Randomization (ASLR)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../format_string/format_string.html">Format String</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../format_string/format_string.html#definition">Definition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../format_string/format_string.html#shellcode-and-format-string">Shellcode and Format String</a></li>
<li class="toctree-l2"><a class="reference internal" href="../format_string/format_string.html#prevention-detection">Prevention/Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../format_string/format_string.html#format-string-versus-bo">Format String versus BO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../format_string/format_string.html#some-vulnerabilities">Some vulnerabilities</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Malware Analysis I</a><ul>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#case-study-mirai">Case Study: Mirai</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#how-to-obtain-malware-sample-the-honey-pot-approach">How to obtain malware sample ? The honey pot approach</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#malware-analysis">Malware Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../malware_analysisII/static_analysis.html">Malware Analysis II</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../malware_analysisII/static_analysis.html#static-analysis">Static Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../malware_analysisII/static_analysis.html#dynamic-analysis">Dynamic Analysis</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">More on packing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#why-packing">Why packing?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-know-if-my-file-is-packed">How to know if my file is packed</a></li>
<li class="toctree-l2"><a class="reference internal" href="#packing-challenges">Packing: challenges</a></li>
<li class="toctree-l2"><a class="reference internal" href="#detect-it-easy-die">Detect it easy (DIE)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#unpacking-get-back-original-binary">Unpacking: get back original binary</a></li>
<li class="toctree-l2"><a class="reference internal" href="#upx-what-is-it"><code class="docutils literal"><span class="pre">UPX</span></code>: what is it ?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#unpacking-tricks">Unpacking tricks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container" >
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<form action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form><ul>
<li><a class="reference internal" href="#">More on packing</a><ul>
<li><a class="reference internal" href="#why-packing">Why packing?</a></li>
<li><a class="reference internal" href="#how-to-know-if-my-file-is-packed">How to know if my file is packed</a></li>
<li><a class="reference internal" href="#packing-challenges">Packing: challenges</a></li>
<li><a class="reference internal" href="#detect-it-easy-die">Detect it easy (DIE)</a></li>
<li><a class="reference internal" href="#unpacking-get-back-original-binary">Unpacking: get back original binary</a></li>
<li><a class="reference internal" href="#upx-what-is-it"><code class="docutils literal"><span class="pre">UPX</span></code>: what is it ?</a><ul>
<li><a class="reference internal" href="#execution-of-upx-packed-file">Execution of UPX packed file</a></li>
<li><a class="reference internal" href="#illustration">Illustration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#unpacking-tricks">Unpacking tricks</a></li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="body col-md-9 content" role="main" >
      
  <div class="section" id="more-on-packing">
<h1>More on packing<a class="headerlink" href="#more-on-packing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="why-packing">
<h2>Why packing?<a class="headerlink" href="#why-packing" title="Permalink to this headline">¶</a></h2>
<p>To compress a file and reduce its size but also to obfuscate a file.</p>
<ul class="simple">
<li>Well known packers: <code class="docutils literal"><span class="pre">UPX,</span> <span class="pre">THEMIDA</span></code> , … (can be combined</li>
<li>Warning: Algorithms may vary with architecture (32 or 64 bits)</li>
</ul>
</div>
<div class="section" id="how-to-know-if-my-file-is-packed">
<h2>How to know if my file is packed<a class="headerlink" href="#how-to-know-if-my-file-is-packed" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">PE</span></code> or <code class="docutils literal"><span class="pre">ELF</span></code> file with unclassic sections</li>
<li>Few dynamic links</li>
</ul>
<div class="line-block">
<div class="line"><em>Unpacked</em></div>
</div>
<img alt="../_images/48.PNG" class="align-center" src="../_images/48.PNG" style="width: 407.20000000000005px; height: 338.40000000000003px;" />
<div class="line-block">
<div class="line"><em>Packed</em></div>
</div>
<img alt="../_images/49.PNG" class="align-center" src="../_images/49.PNG" style="width: 295.2px; height: 36.0px;" />
</div>
<div class="section" id="packing-challenges">
<h2>Packing: challenges<a class="headerlink" href="#packing-challenges" title="Permalink to this headline">¶</a></h2>
<p>Difficulties with packing:</p>
<ol class="arabic simple">
<li>To identify which packer has been used</li>
<li>To unpack the file</li>
</ol>
<p>Solutions:</p>
<ul class="simple">
<li>PIED, OLLYDBG, YARA rules , detect it easy (DIE), machine learning</li>
<li>Call the packer itself , or disassemble if the functionality does not
exists</li>
</ul>
</div>
<div class="section" id="detect-it-easy-die">
<h2>Detect it easy (DIE)<a class="headerlink" href="#detect-it-easy-die" title="Permalink to this headline">¶</a></h2>
<img alt="../_images/50.PNG" class="align-center" src="../_images/50.PNG" style="width: 317.4px; height: 189.29999999999998px;" />
<p>DIE is based on Yara!</p>
</div>
<div class="section" id="unpacking-get-back-original-binary">
<h2>Unpacking: get back original binary<a class="headerlink" href="#unpacking-get-back-original-binary" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">When you execute the packed file, you’ll reveal the true behavior of
your file at dynamic level but this does not mean that you’ll get back
the original code, i.e., you cannot do any type of static analysis.</div>
<div class="line">To get back the original binary code you need to unpack the file and
dump the memory at the right moment.</div>
</div>
<ul class="simple">
<li>Right moment <img class="math" src="../_images/math/f83e0c11055f53d8b8d4d5968e1adb756869862c.png" alt="="/> when the cypher process has been reversed .</li>
</ul>
</div>
<div class="section" id="upx-what-is-it">
<h2><code class="docutils literal"><span class="pre">UPX</span></code>: what is it ?<a class="headerlink" href="#upx-what-is-it" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">UPX</span></code> uses a data compression algorithm called <code class="docutils literal"><span class="pre">UCL</span></code></li>
<li><code class="docutils literal"><span class="pre">UPX</span></code> (since 2.90 beta) can use <code class="docutils literal"><span class="pre">LZMA</span></code> (data compression based on
Markov Chains) on most platforms; however, this is disabled by
default for 16 bit due to slow decompression speed on older computers
(use lzma to force it on)</li>
<li>Starting with version 3.91, <code class="docutils literal"><span class="pre">UPX</span></code> also supports 64 Bit (x64)
executable files on the Windows platform. This feature is currently
declared as experimental</li>
</ul>
<div class="section" id="execution-of-upx-packed-file">
<h3>Execution of UPX packed file<a class="headerlink" href="#execution-of-upx-packed-file" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Assume a 32 bits architecture</div>
<div class="line">There is a clear pattern to the unpacker code section:</div>
</div>
<ol class="arabic simple">
<li>Push all the registers with <code class="docutils literal"><span class="pre">pushad</span></code></li>
<li>Unpacks the code in physical memory (Lots of rewritting of sections)</li>
<li>Pop back all registers using <code class="docutils literal"><span class="pre">popad</span></code></li>
<li>Jump to unpacked code</li>
<li>Run it!</li>
</ol>
<img alt="../_images/51.PNG" class="align-center" src="../_images/51.PNG" style="width: 132.0px; height: 164.0px;" />
<p>Unpacking UPX is relatively easy</p>
<ol class="arabic simple">
<li>Put a break point after <code class="docutils literal"><span class="pre">popad</span></code></li>
<li>Follow the next jump</li>
<li><strong>Dump</strong> starting from jump destination (it become new entry point
address)</li>
<li>Restore import table with respect to new entry point address</li>
</ol>
<p>Important observation:</p>
<ul class="simple">
<li>this requires to disassemble the file!</li>
</ul>
</div>
<div class="section" id="illustration">
<h3>Illustration<a class="headerlink" href="#illustration" title="Permalink to this headline">¶</a></h3>
<img alt="../_images/52.PNG" class="align-center" src="../_images/52.PNG" style="width: 638.0px; height: 352.5px;" />
<img alt="../_images/53.PNG" class="align-center" src="../_images/53.PNG" style="width: 714.0px; height: 347.5px;" />
<img alt="../_images/55.png" class="align-center" src="../_images/55.png" style="width: 651.0px; height: 394.5px;" />
<img alt="../_images/56.PNG" class="align-center" src="../_images/56.PNG" style="width: 628.5px; height: 337.0px;" />
<p>Important observation:</p>
<ul class="simple">
<li>this requires to disassemble the file!</li>
<li><code class="docutils literal"><span class="pre">pushad</span></code> and <code class="docutils literal"><span class="pre">popad</span></code> do not exist on 64bit architectures. But one
can still check for double 0 repetitions</li>
</ul>
<img alt="../_images/57.PNG" class="align-center" src="../_images/57.PNG" style="width: 350.0px; height: 179.5px;" />
</div>
</div>
<div class="section" id="unpacking-tricks">
<h2>Unpacking tricks<a class="headerlink" href="#unpacking-tricks" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Put breakpoints at the end of loops: At this point try to re analyze
the binary for new assembly routines</li>
<li>Look for calls that don’t return or jumps with no code after them</li>
<li>Look for long jumps that jump into a different section: These can
indicate a jump from the unpacking stub and the binary itself</li>
<li>Look for <code class="docutils literal"><span class="pre">pushad</span></code> . Sent a memory breakpoint on these stack
addresses, which should break on the corresponding <code class="docutils literal"><span class="pre">popad</span></code> . These
are often used to save the context for main.</li>
<li>Add breakpoints on <code class="docutils literal"><span class="pre">GetVersion</span></code> or <code class="docutils literal"><span class="pre">GetCommandLineA</span></code> : These are
often called from the normal main wrapper that windows compilers add
<code class="docutils literal"><span class="pre">GetModuleHandle</span></code> for GUI apps</li>
<li>Some more advanced unpacker only unpack ‘on demand’, meaning that the
whole binary is never fully unpacked unless you touch all
functionality. This can usually be avoided by scripting your debugger
to call the appropriate unpacking routines</li>
</ul>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Memory dump and memory forensics can be used in many situations</li>
<li>Dynamic analysis sometimes ) can go further than static analysis</li>
<li>But dynamic analysis can also easily be bypassed</li>
<li>Indeed, malware can detect if they’re in a virtualized environment</li>
<li>Solution: let us do some research and take the best of boths</li>
</ol>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a id="up" href="#">
        <span class="fa fa-chevron-up"></span>
      </a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../_sources/malware_analysisI/packing.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2020, Legay Axel, Dûchene Fabien, Crochet Christophe, Schmitz Donatien.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7.<br/>
    </p>
  </div>
</footer>
  </body>
</html>